state = "MD",
year = 2020,
geometry = TRUE)
# Merge the place and tract data
maryland_data <- bind_rows(places_data, tracts_data)
#B19013 defined: https://www.socialexplorer.com/data/ACS2010_5yr/metadata/?ds=ACS10_5yr&var=B19013001
md_named <- md_named %>%
mutate(GEOID = as.character(tract))
md_named <- read.csv("../output/md_smith_data_12.16.csv") %>%
rename(lat = INTPTLAT, long = INTPTLONG)
library(sf)
md_named <- st_as_sf(md_named, coords = c("long", "lat"), crs = 4326)
md_named <- st_set_crs(md_named, 4326) %>%
st_transform(4326)
md_named <- md_named %>%
st_as_sf(., coords = c("long", "lat")) %>%
st_buffer(dist = 0.01) # convert points to polygons
#addCircles(data = md_named, radius = 500, fillOpacity = 0.5, ...)
# #Map by Median Income Difference
# md_named<- md_named %>%
#    sf::st_transform('+proj=longlat +datum=WGS84')
#subset the geometry
#2020 Median Income By Census Tract ACS
#2016-2020
#B19001 COUNTS THE NUMBER OF HOUSEHOLDS
#B19013_001 is the household median income
md_income2020_geo <- get_acs(geography = "tract",
variables = c(number_households = "B19001_001", median_income = "B19013_001"),
state = "MD",
year = 2020, geometry = TRUE) %>%
mutate(year=("2020")) %>%
select(GEOID, NAME)
maryland_places_data <- get_acs(geography = "place",
variables = c(number_households = "B19001_001", median_income = "B19013_001"),
state = "MD",
year = 2020)
# Retrieve ACS data for places in Maryland
places_data <- get_acs(geography = "place",
variables = c(number_households = "B19001_001", median_income = "B19013_001"),
state = "MD",
year = 2020)
# Retrieve ACS data for tracts in Maryland
# Ensure caching of shapefiles
options(tigris_use_cache = TRUE)
tracts_data <- get_acs(geography = "tract",
variables = c(number_households = "B19001_001", median_income = "B19013_001"),
state = "MD",
year = 2020,
geometry = TRUE)
# Merge the place and tract data
maryland_data <- bind_rows(places_data, tracts_data)
#B19013 defined: https://www.socialexplorer.com/data/ACS2010_5yr/metadata/?ds=ACS10_5yr&var=B19013001
md_named <- md_named %>%
mutate(GEOID = as.character(tract))
#join geocoordinates
md2 <- md_income2020_geo  %>%
right_join(md_named, by=c("GEOID")) %>%
distinct()
md2 <- md_income2020_geo  %>%
st_join(md_named, by=c("GEOID")) %>%
distinct()
glimpse(md_named)
glimpse(md_income2020_geo)
md2 <- md_income2020_geo  %>%
right_join(md_named, by=c("GEOID")) %>%
distinct()
library(sf)
# Then use st_join instead of right_join
md2 <- st_join(md_income2020_geo, md_named, by = "GEOID", join = right)
md2 <- md_income2020_geo %>%
st_join(st_as_sf(md_named), by = "GEOID")
# Convert sf object to regular data frame
md_income2020_regular <- st_drop_geometry(md_income2020_geo)
# Then do the regular join
md2 <- md_income2020_regular %>%
right_join(md_named, by = "GEOID") %>%
distinct()
View(md2)
md2 <- md2 %>%
sf::st_transform('+proj=longlat +datum=WGS84')
pal <- colorNumeric(
palette = "inferno",
domain = md2$pct_anymembershp_zip
)
#https://leaflet-extras.github.io/leaflet-providers/preview/
leafMap <- leaflet() %>%
addProviderTiles(providers$Esri.WorldStreetMap) %>%
addPolygons(data = md2,
color = ~pal(md2$pct_anymembershp_zip),
weight = 2.5,
smoothFactor = 0.2,
fillOpacity = 0.5,
label = paste("Pct membership in civic groups is:",(md2$pct_anymembershp_zip), "Income is",(md2$income_per_capita), "in", (md2$NAME.y), "zip code", (md2$zip))) %>%
addControl(
html = '<div id="legend" style="background-color: white; padding: 10px; border-radius: 5px; border: 1px solid #ccc; text-align: center;">
<p><strong>Pct Membership 2020</strong></p>
<div style="background-color: gray; height: 20px; width: 30px; display: inline-block;"></div> 0: NA
<br>
<div style="background-color: black; height: 20px; width: 30px; display: inline-block;"></div> 30-39%
<br>
<div style="background-color: #e75480; height: 20px; width: 30px; display: inline-block;"></div> 40-45%
<br>
<div style="background-color: #fa8072; height: 20px; width: 30px; display: inline-block;"></div> 46-50%
<br>
<div style="background-color: #ffffbf; height: 20px; width: 30px; display: inline-block;"></div> 51-60%
</div>',
position = "bottomright"
) %>%
addControl(
html = "<div style='background-color: white; padding: 5px; border-radius: 3px;'><h3>Civil Membership & Income in Maryland</h3></div>",
position = "topright"
)
md2 <- md2 %>%
sf::st_transform("EPSG:4326")
md2 <- st_as_sf(md2)
md2 <- md2 %>%
sf::st_transform('+proj=longlat +datum=WGS84')
pal <- colorNumeric(
palette = "inferno",
domain = md2$pct_anymembershp_zip
)
#https://leaflet-extras.github.io/leaflet-providers/preview/
leafMap <- leaflet() %>%
addProviderTiles(providers$Esri.WorldStreetMap) %>%
addPolygons(data = md2,
color = ~pal(md2$pct_anymembershp_zip),
weight = 2.5,
smoothFactor = 0.2,
fillOpacity = 0.5,
label = paste("Pct membership in civic groups is:",(md2$pct_anymembershp_zip), "Income is",(md2$income_per_capita), "in", (md2$NAME.y), "zip code", (md2$zip))) %>%
addControl(
html = '<div id="legend" style="background-color: white; padding: 10px; border-radius: 5px; border: 1px solid #ccc; text-align: center;">
<p><strong>Pct Membership 2020</strong></p>
<div style="background-color: gray; height: 20px; width: 30px; display: inline-block;"></div> 0: NA
<br>
<div style="background-color: black; height: 20px; width: 30px; display: inline-block;"></div> 30-39%
<br>
<div style="background-color: #e75480; height: 20px; width: 30px; display: inline-block;"></div> 40-45%
<br>
<div style="background-color: #fa8072; height: 20px; width: 30px; display: inline-block;"></div> 46-50%
<br>
<div style="background-color: #ffffbf; height: 20px; width: 30px; display: inline-block;"></div> 51-60%
</div>',
position = "bottomright"
) %>%
addControl(
html = "<div style='background-color: white; padding: 5px; border-radius: 3px;'><h3>Civil Membership & Income in Maryland</h3></div>",
position = "topright"
)
saveWidget(leafMap, "../output/state_member_all_map_jan_28.html")
leafMap
View(md2)
pal <- colorNumeric(
palette = "inferno",
domain = md2$pct_anymembershp_zip
)
#https://leaflet-extras.github.io/leaflet-providers/preview/
leafMap <- leaflet() %>%
addProviderTiles(providers$Esri.WorldStreetMap) %>%
addPolygons(data = md2,
color = ~pal(md2$pct_anymembershp_zip),
weight = 2.5,
smoothFactor = 0.2,
fillOpacity = 0.5,
label = paste("Pct membership in civic groups is:",(md2$pct_anymembershp_zip), "Income is",(md2$income_per_capita), "in", (md2$NAME.y), "zip code", (md2$zip))) %>%
addControl(
html = '<div id="legend" style="background-color: white; padding: 10px; border-radius: 5px; border: 1px solid #ccc; text-align: center;">
<p><strong>Pct Membership 2020</strong></p>
<div style="background-color: gray; height: 20px; width: 30px; display: inline-block;"></div> 0: NA
<br>
<div style="background-color: black; height: 20px; width: 30px; display: inline-block;"></div> 30-39%
<br>
<div style="background-color: #e75480; height: 20px; width: 30px; display: inline-block;"></div> 40-45%
<br>
<div style="background-color: #fa8072; height: 20px; width: 30px; display: inline-block;"></div> 46-50%
<br>
<div style="background-color: #ffffbf; height: 20px; width: 30px; display: inline-block;"></div> 51-60%
</div>',
position = "bottomright"
) %>%
addControl(
html = "<div style='background-color: white; padding: 5px; border-radius: 3px;'><h3>Civil Membership & Income in Maryland</h3></div>",
position = "topright"
)
#saveWidget(leafMap, "../output/state_member_all_map_jan_28.html")
leafMap
#list of businesses losing foot traffic y-y
dundalk <- read.csv("../data/dundalk_loser.csv")
arundel <- read.csv("../data/arundel_loser.csv")
View(arundel)
View(md_named)
foot_geo <- read.csv("../data/foot_traffic_geocode_lookup.csv")
View(dundalk)
View(foot_geo)
dundalk1 <- dundalk |>
inner_join(foot_geo, by=c("location_name", "street_address"))
View(dundalk1)
dundalk1 |>
count(location_name)
dundalk1 |>
count(location_name) |>
arrange(desc(n))
dundalk |>
count(location_name) |>
arrange(desc(n))
View(md_named)
dundalk1 <- st_as_sf(dundalk1, coords = c("long", "lat"), crs = 4326)
names(dundalk1)
dundalk1 <- st_as_sf(dundalk1, coords = c("lon", "lat"), crs = 4326)
View(dundalk1)
dundalk1 <- dundalk |>
inner_join(foot_geo, by=c("location_name", "street_address", "city", "region", "postal_code", "dln_visits_yoy"))
dundalk1 <- dundalk |>
inner_join(foot_geo, by=c("location_name", "street_address", "city", "region", "postal_code"))
names(dundalk1)
dundalk1 <- dundalk |>
inner_join(foot_geo, by=c("location_name", "street_address", "city", "region", "postal_code")) |>
select( "location_name",               "street_address",            "city",                        "region",                      "postal_code",  "foot_traffic_yoy", "address", "placekey","naics4", "poi_tract", "nvisits",  "nvisits_lyear",               "nvisitor_total", "dln_visits_yoy.y",            "pct_nvisitor_same_cty"       "pct_nvisitor_same_tract", "pct_nvisitor_within_1mile",   "pct_nvisitor_within_5mile",   "pct_nvisitor_within_10mile", "pct_nvisitor_outside_10mile", "brands", "max_nvisits",                 "min_nvisits", "fulladdress",                 "lon",                         "lat" )
dundalk1 <- dundalk |>
inner_join(foot_geo, by=c("location_name", "street_address", "city", "region", "postal_code")) |>
select(
"location_name", "street_address", "city", "region", "postal_code",
"foot_traffic_yoy", "address", "placekey", "naics4", "poi_tract",
"nvisits", "nvisits_lyear", "nvisitor_total", "dln_visits_yoy.y",
"pct_nvisitor_same_cty", "pct_nvisitor_same_tract", "pct_nvisitor_within_1mile",
"pct_nvisitor_within_5mile", "pct_nvisitor_within_10mile", "pct_nvisitor_outside_10mile",
"brands", "max_nvisits", "min_nvisits", "fulladdress", "lon", "lat"
)
View(dundalk1)
dundalk1 <- dundalk |>
inner_join(foot_geo, by=c("location_name", "street_address", "city", "region", "postal_code")) |>
select(
"location_name", "street_address", "city", "region", "postal_code",
"foot_traffic_yoy", "address", "placekey", "naics4", "poi_tract",
"nvisits", "nvisits_lyear", "nvisitor_total", "dln_visits_yoy.y",
"pct_nvisitor_same_cty", "pct_nvisitor_same_tract", "pct_nvisitor_within_1mile",
"pct_nvisitor_within_5mile", "pct_nvisitor_within_10mile", "pct_nvisitor_outside_10mile",
"brands", "max_nvisits", "min_nvisits", "fulladdress", "lon", "lat"
) |>
rename(dln_visits_yoy = dln_visits_yoy.y)
dundalk1 <- st_as_sf(dundalk1, coords = c("lon", "lat"), crs = 4326)
dundalk1 <- dundalk |>
inner_join(foot_geo, by=c("location_name", "street_address", "city", "region", "postal_code")) |>
select(
"location_name", "street_address", "city", "region", "postal_code",
"foot_traffic_yoy", "address", "placekey", "naics4", "poi_tract",
"nvisits", "nvisits_lyear", "nvisitor_total", "dln_visits_yoy.y",
"pct_nvisitor_same_cty", "pct_nvisitor_same_tract", "pct_nvisitor_within_1mile",
"pct_nvisitor_within_5mile", "pct_nvisitor_within_10mile", "pct_nvisitor_outside_10mile",
"brands", "max_nvisits", "min_nvisits", "fulladdress", "lon", "lat"
) |>
rename(dln_visits_yoy = dln_visits_yoy.y)
library(sf)
dundalk1 <- st_as_sf(dundalk1, coords = c("lon", "lat"), crs = 4326)
pal <- colorNumeric(
palette = "inferno",
domain = dundalk1$dln_visits_yoy
)
#https://leaflet-extras.github.io/leaflet-providers/preview/
leafMap <- leaflet() %>%
addProviderTiles(providers$Esri.WorldStreetMap) %>%
addPolygons(data = md2,
color = ~pal(dundalk1$dln_visits_yoy),
weight = 2.5,
smoothFactor = 0.2,
fillOpacity = 0.5,
label = paste("Decline in foot traffic at", (dundalk1$location_name), "was", (dundalk1$dln_visits_yoy), "at this address:", (dundalk1$fulladdress))) %>%
addControl(
html = '<div id="legend" style="background-color: white; padding: 10px; border-radius: 5px; border: 1px solid #ccc; text-align: center;">
<p><strong>Pct Membership 2020</strong></p>
<div style="background-color: gray; height: 20px; width: 30px; display: inline-block;"></div> 0: NA
<br>
<div style="background-color: black; height: 20px; width: 30px; display: inline-block;"></div> 30-39%
<br>
<div style="background-color: #e75480; height: 20px; width: 30px; display: inline-block;"></div> 40-45%
<br>
<div style="background-color: #fa8072; height: 20px; width: 30px; display: inline-block;"></div> 46-50%
<br>
<div style="background-color: #ffffbf; height: 20px; width: 30px; display: inline-block;"></div> 51-60%
</div>',
position = "bottomright"
) %>%
addControl(
html = "<div style='background-color: white; padding: 5px; border-radius: 3px;'><h3>Civil Membership & Income in Maryland</h3></div>",
position = "topright"
)
#saveWidget(leafMap, "../output/state_member_all_map_jan_28.html")
leafMap
pal <- colorNumeric(
palette = "inferno",
domain = dundalk1$dln_visits_yoy
)
#https://leaflet-extras.github.io/leaflet-providers/preview/
leafMap <- leaflet() %>%
addProviderTiles(providers$Esri.WorldStreetMap) %>%
addPolygons(data = md2,
color = ~pal(dundalk1$dln_visits_yoy),
weight = 2.5,
smoothFactor = 0.2,
fillOpacity = 0.5,
label = paste("Decline in foot traffic at", (dundalk1$location_name), "was", (dundalk1$dln_visits_yoy), "at this address:", (dundalk1$fulladdress))) %>%
addControl(
html = "<div style='background-color: white; padding: 5px; border-radius: 3px;'><h3>Decline in Foot Traffic at Dundalk Businesses since Key Bridge Collapse</h3></div>",
position = "topright"
)
#saveWidget(leafMap, "../output/state_member_all_map_jan_28.html")
leafMap
head(dundalk1)
# Create color palette for the points
pal <- colorNumeric(
palette = "inferno",
domain = dundalk1$dln_visits_yoy
)
# Create the leaflet map
leafMap <- leaflet() %>%
# Add base map
addProviderTiles(providers$Esri.WorldStreetMap) %>%
# Set view to Dundalk's approximate coordinates and zoom level
setView(lng = -76.52, lat = 39.27, zoom = 13) %>%
# Add points for businesses
addCircleMarkers(
data = dundalk1,
radius = 8,
color = "black",
weight = 1,
fillColor = ~pal(dln_visits_yoy),
fillOpacity = 0.7,
popup = ~paste("<b>", location_name, "</b><br>",
"Change in foot traffic: ", round(dln_visits_yoy * 100, 1), "%<br>",
"Address: ", fulladdress)
) %>%
# Add legend
addLegend(
position = "bottomright",
pal = pal,
values = dundalk1$dln_visits_yoy,
title = "Change in Foot Traffic",
labFormat = labelFormat(transform = function(x) round(x * 100, 1))
) %>%
# Add title
addControl(
html = "<div style='background-color: white; padding: 5px; border-radius: 3px;'><h3>Decline in Foot Traffic at Dundalk Businesses since Key Bridge Collapse</h3></div>",
position = "topright"
)
leafMap
# Create color palette for the points
pal <- colorNumeric(
palette = "inferno",
domain = dundalk1$dln_visits_yoy
)
# Create the leaflet map
leafMap <- leaflet() %>%
# Add base map
addProviderTiles(providers$Esri.WorldStreetMap) %>%
# Set view to Dundalk's approximate coordinates and zoom level
setView(lng = -76.52, lat = 39.27, zoom = 13) %>%
# Add points for businesses
addCircleMarkers(
data = dundalk1,
radius = 8,
color = "black",
weight = 1,
fillColor = ~pal(dln_visits_yoy),
fillOpacity = 0.7,
popup = ~paste("<b>", location_name, "</b><br>",
"Change in foot traffic: ", round(dln_visits_yoy, 2), "%<br>",
"Address: ", fulladdress)
) %>%
# Add legend
addLegend(
position = "bottomright",
pal = pal,
values = dundalk1$dln_visits_yoy,
title = "Change in Foot Traffic",
labFormat = labelFormat(transform = function(x) round(x, 2))
) %>%
# Add title
addControl(
html = "<div style='background-color: white; padding: 5px; border-radius: 3px;'><h3>Decline in Foot Traffic at Dundalk Businesses since Key Bridge Collapse</h3></div>",
position = "topright"
)
leafMap
saveWidget(leafMap, "../output/foot_traffic_decline_map_feb_2025.html")
library(ggmap)
register_google(key = "AIzaSyCLhP1Uwd2rv0thzuqab7ane0epa7KOgfw")
dundalk1 <- dundalk %>%
mutate(geo = geocode(fulladdress))
dundalk1 <- dundalk %>%
mutate(geo = geocode(address))
write.csv(dundalk1, "dundalk_geo.csv")
# Create color palette for the points
pal <- colorNumeric(
palette = "inferno",
domain = dundalk1$dln_visits_yoy
)
# Create the leaflet map
leafMap <- leaflet() %>%
# Add base map
addProviderTiles(providers$Esri.WorldStreetMap) %>%
# Set view to Dundalk's approximate coordinates and zoom level
setView(lng = -76.52, lat = 39.27, zoom = 13) %>%
# Add points for businesses
addCircleMarkers(
data = dundalk1,
radius = 8,
color = "black",
weight = 1,
fillColor = ~pal(dln_visits_yoy),
fillOpacity = 0.7,
popup = ~paste("<b>", location_name, "</b><br>",
"Change in foot traffic: ", round(dln_visits_yoy, 2), "%<br>",
"Address: ", fulladdress)
) %>%
# Add legend
addLegend(
position = "bottomright",
pal = pal,
values = dundalk1$dln_visits_yoy,
title = "Change in Foot Traffic",
labFormat = labelFormat(transform = function(x) round(x, 2))
) %>%
# Add title
addControl(
html = "<div style='background-color: white; padding: 5px; border-radius: 3px;'><h3>Decline in Foot Traffic at Dundalk Businesses since Key Bridge Collapse</h3></div>",
position = "topright"
)
dundalk1 <- st_as_sf(dundalk1, coords = c("lon", "lat"), crs = 4326)
dundalk1 <- st_as_sf(dundalk1, coords = c("geo$lon", "geo$lat"), crs = 4326)
dundalk1 <- st_as_sf(dundalk1, coords = c("lon", "lat"), crs = 4326)
glimpse(dundalk1)
dundalk1 <- dundalk1 %>%
tidyr::unnest(geo) %>%
rename(lon = ...1, lat = ...2)  # assuming the columns aren't named in geo
dundalk1 <- dundalk1 %>%
tidyr::unnest(geo)
names(dundalk1)
dundalk1 <- st_as_sf(dundalk1, coords = c("lon", "lat"), crs = 4326)
write.csv(dundalk1, "dundalk_geo.csv")
# Create color palette for the points
pal <- colorNumeric(
palette = "inferno",
domain = dundalk1$dln_visits_yoy
)
# Create the leaflet map
leafMap <- leaflet() %>%
# Add base map
addProviderTiles(providers$Esri.WorldStreetMap) %>%
# Set view to Dundalk's approximate coordinates and zoom level
setView(lng = -76.52, lat = 39.27, zoom = 13) %>%
# Add points for businesses
addCircleMarkers(
data = dundalk1,
radius = 8,
color = "black",
weight = 1,
fillColor = ~pal(dln_visits_yoy),
fillOpacity = 0.7,
popup = ~paste("<b>", location_name, "</b><br>",
"Change in foot traffic: ", round(dln_visits_yoy, 2), "%<br>",
"Address: ", fulladdress)
) %>%
# Add legend
addLegend(
position = "bottomright",
pal = pal,
values = dundalk1$dln_visits_yoy,
title = "Change in Foot Traffic",
labFormat = labelFormat(transform = function(x) round(x, 2))
) %>%
# Add title
addControl(
html = "<div style='background-color: white; padding: 5px; border-radius: 3px;'><h3>Decline in Foot Traffic at Dundalk Businesses since Key Bridge Collapse</h3></div>",
position = "topright"
)
# Create color palette for the points
pal <- colorNumeric(
palette = "inferno",
domain = dundalk1$dln_visits_yoy
)
# Create the leaflet map
leafMap <- leaflet() %>%
# Add base map
addProviderTiles(providers$Esri.WorldStreetMap) %>%
# Set view to Dundalk's approximate coordinates and zoom level
setView(lng = -76.52, lat = 39.27, zoom = 13) %>%
# Add points for businesses
addCircleMarkers(
data = dundalk1,
radius = 8,
color = "black",
weight = 1,
fillColor = ~pal(dln_visits_yoy),
fillOpacity = 0.7,
popup = ~paste("<b>", location_name, "</b><br>",
"Change in foot traffic: ", round(dln_visits_yoy, 2), "%<br>",
"Address: ", address)
) %>%
# Add legend
addLegend(
position = "bottomright",
pal = pal,
values = dundalk1$dln_visits_yoy,
title = "Change in Foot Traffic",
labFormat = labelFormat(transform = function(x) round(x, 2))
) %>%
# Add title
addControl(
html = "<div style='background-color: white; padding: 5px; border-radius: 3px;'><h3>Decline in Foot Traffic at Dundalk Businesses since Key Bridge Collapse</h3></div>",
position = "topright"
)
saveWidget(leafMap, "../output/foot_traffic_decline_map_feb_2025.html")
leafMap
