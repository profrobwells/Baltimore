---
title: "Smith School - Baltimore Data Income Map"
author: "Rob Wells"
date: "7/21/2022"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

Median Income Maps By Census Tract in Baltimore Source: Kyle Walker's
tidycensus tutorial, Rachel Logan's leaflet map code for the Howard
Center

```{r message=FALSE, warning=FALSE}
#remotes::install_github("walkerke/tidycensus")
library(tidyverse)
library(tidycensus)
#a = get_decennial(geography = "state", variables = "P1_001N", year = 2020)
# head(a, 5)
#install.packages("formattable")
library(formattable)
library(htmlwidgets)
library(leaflet)
library(sf)
library(formattable)
library(dplyr)
library(tidyr)
library(janitor)
#install.packages("leaflet.extras")
library(leaflet.extras)
library(googlesheets4)

```

Census API key.

```{r message=FALSE}
census_api_key("9cabe8a191a1f824755d4a1845f13cb08faa2c5f", install = TRUE, overwrite = TRUE)
```

# Import Smith School Baltimore Data
NOTE: Skip to line 87 and Analysis of Smith Data
```{r}
googlesheets4::gs4_deauth()
smith <- read_sheet("https://docs.google.com/spreadsheets/d/1RheKDdtsToCcSLnZoZBYwtN_ISw6E2kgPIQpDQE_BYw/edit?usp=sharing") %>% 
  as.data.frame()

smith <- smith %>% 
  clean_names()

```


```{r}

#join Community Statistical Area names
#associates neighborhood names to Census Tracts using Community Statistical Areas, 2010 https://bniajfi.org/mapping-resources/
#Baltimore has 56 neighborhoods as measured by Community Statistical Areas
csa <- read_csv("../data/balt_census_crosswalks_2020.csv") %>%
  rename(
    geoid = GEOID_Tract_2020
  ) %>%
  clean_names()

#smith$tract <- as.character(smith$tract)

smith1 <- smith  %>% 
  right_join(csa, by=c("tract"="geoid")) %>% 
  distinct() 

#Rename Columns
smith1<- smith1 %>% 
  rename(neighborhood = community_statistical_area_2020,
  census = tract_2020)

#write.csv(smith1, "smith1_balt.csv")



```


### Analysis of Smith Data

```{r}
smith <- read.csv("../data/smith1_balt.csv")
#199 census tracts
#25 zip codes (totalling 199 areas, but need to check boundaries)
x<- smith %>% 
  group_by(zip) %>% 
  count () 
sum(x$n)

#per capita income seems way too low
median(smith$income_per_capita, na.rm = TRUE) #22789.76

median(smith$pct_anymembershp_zip, na.rm = TRUE) #0.455563
summary(smith$pct_anymembershp_zip, na.rm = TRUE) 
# Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
#  0.3353  0.4444  0.4556  0.4613  0.4752  0.5241       3 

median(smith$nbanks_zip, na.rm = TRUE) #5
summary(smith$nbanks_zip, na.rm = TRUE) 
  # Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
  # 0.000   2.000   5.000   5.847   8.000  14.000       3 

median(smith$census_response_rate2020, na.rm = TRUE) #0.564
summary(smith$census_response_rate2020, na.rm = TRUE)
# Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
#  0.2830  0.4753  0.5640  0.5594  0.6522  0.8360       3 


```

## Membership & Income

```{r}
#communities with greater than median membership - 46%- but less than median income - $22,790
himember <- smith %>% 
  group_by(neighborhood) %>% 
  select(pct_anymembershp_zip, income_per_capita, tract) %>% 
  arrange(desc(pct_anymembershp_zip)) %>% 
  filter(pct_anymembershp_zip >= 0.455563) %>% 
  filter(income_per_capita <= 22789.76) %>% 
  mutate(pct_anymembershp_zip = formattable::percent(pct_anymembershp_zip)) %>% 
  
  himember$income_per_capita <- formattable::currency(himember$income_per_capita, digits =0L)
  

library(kableExtra)
himember %>%
  rename(Neighborhood = neighborhood, Membership = pct_anymembershp_zip, Per_Capita_Income = income_per_capita, Census_Tract = tract) %>% 
  kbl(caption = "Communities With Greater than Median Membership - 46%- but Less than Median Income - $22,790", font_size = 50, bold=T) %>%
  kable_classic(full_width = T, html_font = "Cambria") %>%
  column_spec(1, bold = T, border_right = T) %>%
  column_spec(2, border_right = T, width = "10em", background = "yellow") %>% 
  column_spec(3, border_right = T, width = "10em") %>% 
  save_kable(file = "../DataOutput/himember.html", self_contained = T)

```
## Census Response + Income
```{r}
#communities in the upper quartile of census response - 65%- but less than median income - $22,654
hicensus <- smith %>% 
  group_by(neighborhood) %>% 
  select(census_response_rate2020, income_per_capita, pct_anymembershp_zip, tract) %>% 
  arrange(desc(census_response_rate2020)) %>% 
  filter(census_response_rate2020 >= 0.6522) %>% 
  filter(income_per_capita <= 22653.77) %>% 
  mutate(census_response_rate2020 = formattable::percent(census_response_rate2020)) %>% 
  mutate(pct_anymembershp_zip = formattable::percent(pct_anymembershp_zip)) 
  
  hicensus$income_per_capita <- formattable::currency(hicensus$income_per_capita, digits =0L)

  
    hicensus %>%
  rename(Neighborhood = neighborhood, Census_Response = census_response_rate2020, Per_Capita_Income = income_per_capita, Census_Tract = tract, Membership = pct_anymembershp_zip) %>% 
  kbl(caption = "Communities in the Upper Quartile of Census Response - 65%- but Less than Median Income - $22,654", font_size = 50, bold=T) %>%
  kable_classic(full_width = T, html_font = "Cambria") %>%
  column_spec(1, bold = T, border_right = T) %>%
  column_spec(2, border_right = T, width = "10em", background = "yellow") %>% 
  column_spec(3, border_right = T, width = "10em") %>% 
  column_spec(4, border_right = T, width = "10em") %>%     
  save_kable(file = "../DataOutput/hicensus.html", self_contained = T)

```

```{r}

#communities in the upper quartile of census response - 65%- and upper quartile of membership - 46%
smith %>% 
  group_by(neighborhood) %>% 
  select(census_response_rate2020, income_per_capita, pct_anymembershp_zip, nbanks_zip) %>% 
  arrange(desc(census_response_rate2020)) %>% 
  filter(census_response_rate2020 >= 0.6522) %>% 
    filter(pct_anymembershp_zip >= 0.4613) %>% 
  arrange((income_per_capita))


```

## Notes
--run a correlation on census response and income. run a correlation on banks and income. run a correlation on membership and income

corr(d, w = rep(1, nrow(d))/nrow(d)

cov(x, y = NULL, use = "everything",
    method = c("pearson", "kendall", "spearman"))


## fact check income
```{r}
baltcity_income_clean <- read.csv("baltcity_income_clean.csv")

median(baltcity_income_clean$x2020, na.rm = TRUE)
#B19013_001 is the household median income: 49875

baltcity_percap_income <- read_csv("baltcity_percap_income.csv") %>% 
  as.data.frame()
median(baltcity_percap_income$x2020, na.rm = TRUE)

#23422
```

```{r}

library(janitor)
total %>%
  adorn_totals("row")

smith %>% 
  adorn_totals("row")

```

There are two major functions implemented in tidycensus: get_decennial,
which grants access to the 1990, 2000, and 2010 decennial US Census APIs
get_acs, which grants access to the 5-year American Community Survey
APIs.

```{r}
#Calls variables for the 2020 decennial census
v20_dec <- load_variables(2020, "pl", cache = TRUE)
#Calls variables for the 2020 ACS census
v20_acs <- load_variables(2020, "acs5", cache = TRUE)
```

# Census Tract Median Income Using ACS

## Question: The 2010 and 2016 Maryland files each have 2812 rows, but the 2020 state file has 2950 rows. Why?
### this is probably because there are more census tracts recorded in 2020 because of population changes

```{r}
#2020 Median Income By Census Tract ACS
#2016-2020
#B19001 COUNTS THE NUMBER OF HOUSEHOLDS
#B19013_001 is the household median income
md_income2020 <- get_acs(geography = "tract", 
              variables = c(number_households = "B19001_001", median_income = "B19013_001"), 
               state = "MD", 
               year = 2020) %>% 
  mutate(year=("2020"))

 
md_income2020
#B19013 defined: https://www.socialexplorer.com/data/ACS2010_5yr/metadata/?ds=ACS10_5yr&var=B19013001
```

```{r}
#2016 Median Income By Census Tract ACS
#2016-2012
md_income2016 <- get_acs(geography = "tract", 
              variables = c(number_households = "B19001_001", median_income = "B19013_001"), 
               state = "MD", 
               year = 2016) %>% 
  mutate(year=("2016"))
 
md_income2016
```

```{r}
#2010 Median Income By Census Tract 2010
#2006-2010 sample
md_income2010 <- get_acs(geography = "tract", 
              variables = c(number_households = "B19001_001", median_income = "B19013_001"), 
               state = "MD", 
               year = 2010) %>% 
  mutate(year=("2010"))
 
md_income2010
```

## Create Baltimore city-county, city files

```{r}
#Bind together 2010, 2016, 2020 files

md_income_all <- rbind(md_income2010, md_income2016, md_income2020)

md_income_all <- separate(data = md_income_all, col = NAME, into = c("Census_Tract", "County", "State"), sep = ",", extra = "merge", fill = "right")

#write.csv(md_income_all, "md_income_all.csv")

#Subset Baltimore city-county, city files
balt_income_all <- filter(md_income_all, grepl ("Baltimore", County))
#write.csv(balt_income_all, "balt_income_all.csv")

#Baltimore city median income, 2010, 2016, 2020

baltcity_income <- filter(balt_income_all, grepl ("Baltimore city", County)) %>% 
  filter(variable=="median_income")

```

```{r}
#reshape baltcity_income table

baltcity_income <- baltcity_income %>% 
  dplyr::select(-moe) %>% 
  pivot_wider(names_from = "year", values_from = "estimate")

baltcity_income <- janitor::clean_names(baltcity_income)

baltcity_income <- baltcity_income %>% 
  mutate(diff_2020_2010 = (x2020-x2010)) %>% 
  mutate(diff_2020_2016 = (x2020-x2016))

# write.csv(baltcity_income, "baltcity_income.csv")
# write_rds(baltcity_income, "baltcity_income.rds")
```

# Map High Membership, Below Median Communities


```{r}
#subset the geometry
md_income2020_geo <- get_acs(geography = "tract", 
              variables = c(number_households = "B19001_001", median_income = "B19013_001"), 
               state = "MD", 
               year = 2020, geometry = TRUE) %>% 
  mutate(year=("2020")) %>% 
  select(GEOID, NAME)

himember <- himember %>% 
  mutate(GEOID = as.character(tract))

#join geocoordinates with baltcity
himember2 <- md_income2020_geo  %>% 
 right_join(himember, by=c("GEOID")) %>% 
 distinct()

himember2$pct_anymembershp_zip <- formattable::percent(himember2$pct_anymembershp_zip, 1)

himember2$income_per_capita <-
  paste0('$', round(himember2$income_per_capita,0))

# #join Community Statistical Area names
# #associates neighborhood names to Census Tracts using Community Statistical Areas, 2010 https://bniajfi.org/mapping-resources/
# #Baltimore has 56 neighborhoods as measured by Community Statistical Areas
# csa <- read_csv("balt_census_crosswalks_2020.csv") %>%
#   rename(
#     geoid = GEOID_Tract_2020
#   ) %>%
#   clean_names()
# 
# csa$geoid <- as.character(csa$geoid)
# 
# baltcity_income <- baltcity_income  %>% 
#   clean_names() %>%
#   right_join(csa, by=c("geoid")) %>% 
#   distinct() 
# 
# #Rename Columns
# baltcity_income <- baltcity_income %>% 
#   rename(neighborhood = community_statistical_area_2020,
#   census = tract_2020)

#write_rds(baltcity_income, "baltcity_income.rds")
#write.csv(baltcity_income, "baltcity_income.csv")
#Census Tracts 1801, 1802 have no data for 2020, but have data for 2010, 2016

```

```{r}
#Map by Median Income Difference
himember2 <- himember2 %>% 
  sf::st_transform('+proj=longlat +datum=WGS84')

pal <- colorNumeric(
  palette = "inferno",
  domain = himember2$pct_anymembershp_zip
)

#https://leaflet-extras.github.io/leaflet-providers/preview/
leafMap <- leaflet() %>%
  addProviderTiles(providers$Esri.WorldStreetMap) %>%
  addPolygons(data = himember2,
              color = ~pal(pct_anymembershp_zip),
              weight = 2.5,
              smoothFactor = 0.2,
              fillOpacity = 0.5,
              label = paste("Pct membership in civic groups is:",(himember2$pct_anymembershp_zip), "and income is",(himember2$income_per_capita), "in", (himember2$neighborhood))) %>% 
  addLegend(
    position = "bottomright",
    pal = pal,
    values = himember2$pct_anymembershp_zip,
    title = "Pct Membership <br> 2020"
  )

saveWidget(leafMap, "../membership_map_dec_18.html")
leafMap
```

# Map Median Income by Census Tract

```{r}
#subset the geometry
md_income2020_geo <- get_acs(geography = "tract", 
              variables = c(number_households = "B19001_001", median_income = "B19013_001"), 
               state = "MD", 
               year = 2020, geometry = TRUE) %>% 
  mutate(year=("2020")) %>% 
  select(GEOID, NAME)

#join geocoordinates with baltcity
baltcity_income <- md_income2020_geo  %>% 
 right_join(baltcity_income, by=c("GEOID"="geoid")) %>% 
 distinct()

#join Community Statistical Area names
#associates neighborhood names to Census Tracts using Community Statistical Areas, 2010 https://bniajfi.org/mapping-resources/
#Baltimore has 56 neighborhoods as measured by Community Statistical Areas
csa <- read_csv("balt_census_crosswalks_2020.csv") %>%
  rename(
    geoid = GEOID_Tract_2020
  ) %>%
  clean_names()

csa$geoid <- as.character(csa$geoid)

baltcity_income <- baltcity_income  %>% 
  clean_names() %>%
  right_join(csa, by=c("geoid")) %>% 
  distinct() 

#Rename Columns
baltcity_income <- baltcity_income %>% 
  rename(neighborhood = community_statistical_area_2020,
  census = tract_2020)

#write_rds(baltcity_income, "baltcity_income.rds")
#write.csv(baltcity_income, "baltcity_income.csv")
#Census Tracts 1801, 1802 have no data for 2020, but have data for 2010, 2016

```


```{r}
#Map by Median Income Difference
baltcity_income <- baltcity_income %>% 
  sf::st_transform('+proj=longlat +datum=WGS84')

pal <- colorNumeric(
  palette = "inferno",
  domain = baltcity_income$fdiff_2020_2010
)

#https://leaflet-extras.github.io/leaflet-providers/preview/
leafMap <- leaflet() %>%
  addProviderTiles(providers$Esri.WorldStreetMap) %>%
  addPolygons(data = baltcity_income,
              color = ~pal(diff_2020_2010),
              weight = 2.5,
              smoothFactor = 0.2,
              fillOpacity = 0.5,
              label = paste("Change is:",(scales::dollar(baltcity_income$diff_2020_2010)), "for",baltcity_income$neighborhood)) %>% 
  addLegend(
    position = "bottomright",
    pal = pal,
    values = baltcity_income$diff_2020_2010,
    title = "Median Income Change<br>Per Census Tract <br> 2010 to 2020"
  )

saveWidget(leafMap, "lealMap.html")
leafMap
```

```{r}
#Top / bottom Census tracts
#For Baltimore Data Day presentation
#Census tracts: generally 1,200 and 8,000 people, optimum size of 4,000
x <- baltcity_income %>% 
  as.data.frame() %>% 
  select(neighborhood, x2020, x2010, diff_2020_2010, census) %>% 
  top_n(10, diff_2020_2010) %>%
  arrange(desc(diff_2020_2010))

x$x2010 <- formattable::currency(x$x2010, "$", format = "d")
x$x2020 <- formattable::currency(x$x2020, "$", format = "d")
x$diff_2020_2010 <- formattable::currency(x$diff_2020_2010, "$", format = "d")
```

```{r}
library(knitr)
library(kableExtra)
# install.packages("knitr")
# install.packages("kableExtra")
#install.packages("magick")
#library(magick)    
x %>% 
  kbl() %>% 
    kable_paper(full_width = F) %>%
  column_spec(1, bold = T, border_right = T) %>%
  column_spec(4, width = "10em", background = "yellow") %>%     save_kable("/DataOutput/Census.pdf", density =1000)
```


```{r}
#Bottom Census tracts
#For Baltimore Data Day presentation
#Census tracts: generally 1,200 and 8,000 people, optimum size of 4,000
min <- baltcity_income %>% 
  as.data.frame() %>% 
  select(neighborhood, x2020, x2010, diff_2020_2010, census) %>% 
  slice_min(diff_2020_2010, n=10) 

min$x2010 <- formattable::currency(min$x2010, "$", format = "d")
min$x2020 <- formattable::currency(min$x2020, "$", format = "d")
min$diff_2020_2010 <- formattable::currency(min$diff_2020_2010, "$", format = "d")
```


```{r}
library(knitr)
library(kableExtra)
# install.packages("knitr")
# install.packages("kableExtra")
#install.packages("magick")
#library(magick)    
min %>% 
  kbl() %>% 
    kable_paper(full_width = F) %>%
  column_spec(1, bold = T, border_right = T) %>%
  column_spec(4, width = "10em", background = "yellow") %>%     save_kable("DataOutput/Min_Census.png")
```


# Statewide median income by place

```{r}
#2020-2010 Median Income By Maryland City ACS
#B19001 COUNTS THE NUMBER OF HOUSEHOLDS
#B19013_001 is the household median income
city_md_income2020 <- get_acs(geography = "place", 
              variables = c(number_households = "B19001_001", median_income = "B19013_001"), 
               state = "MD", 
               year = 2020) %>% 
  mutate(year=("2020"))

 
city_md_income2020
#B19013 defined: https://www.socialexplorer.com/data/ACS2010_5yr/metadata/?ds=ACS10_5yr&var=B19013001

city_md_income2020 <- separate(data = city_md_income2020, col = NAME, into = c("Place", "State"), sep = ",", extra = "merge", fill = "right")

#2010
city_md_income2010 <- get_acs(geography = "place", 
              variables = c(number_households = "B19001_001", median_income = "B19013_001"), 
               state = "MD", 
               year = 2010) %>% 
  mutate(year=("2010"))

city_md_income2010 <- separate(data = city_md_income2010, col = NAME, into = c("Place", "State"), sep = ",", extra = "merge", fill = "right")
#combine
city_md_income <- rbind(city_md_income2010, city_md_income2020)
#reshape, pivot
city_md_income <- city_md_income %>% 
  dplyr::select(-moe) %>% 
  pivot_wider(names_from = "year", values_from = "estimate")

number <- city_md_income %>%
    filter(variable =="number_households")

median <- city_md_income %>%
    filter(variable =="median_income")

Xcity_md_income <- number %>% 
  inner_join(median, by=c("GEOID", "Place", "State")) %>%  
  janitor::clean_names() 

city_md_income <- Xcity_md_income %>%
    rename(households = variable_x, household_2010 = x2010_x, household_2020 = x2020_x, median_income = variable_y, median_inc_2010 = x2010_y, median_inc_2020 = x2020_y)

write.csv(city_md_income, "city_md_income.csv")
```



```{r}
#Analyze Md cities median income


y <- city_md_income %>% 
  mutate(diff_income = (median_inc_2020-median_inc_2010)) %>% 
  mutate(pct_income_chg = (median_inc_2020-median_inc_2010)/median_inc_2010) %>% 
  mutate(diff_pop = (household_2020-household_2010)) %>% 
  mutate(pct_pop = (household_2020-household_2010)/household_2010) %>% 
  filter(household_2020 > 3512) %>% 
  dplyr::select(place, diff_income, pct_income_chg, median_inc_2010, median_inc_2020) %>% 
  arrange(desc(pct_income_chg))

y$diff_income <- formattable::currency(y$diff_income, "$", format = "d")
y$median_inc_2010 <- formattable::currency(y$median_inc_2010, "$", format = "d")
y$median_inc_2020 <- formattable::currency(y$median_inc_2020, "$", format = "d")
y$pct_income_chg <- formattable::percent(y$pct_income_chg, 1)

md_city_summary <- y

#Clean names
md_city_summary$place <- gsub("CDP", "", md_city_summary$place)
md_city_summary$place <- gsub("city", "", md_city_summary$place)
md_city_summary$place <- gsub("town", "", md_city_summary$place)


write.csv(md_city_summary, "md_city_summary.csv")

```

```{r}
#Chart of cities
ggplot(md_city_summary,aes(x = reorder(place, -pct_income_chg), y = pct_income_chg,
             fill = pct_income_chg)) +
  geom_col(position = "dodge") + 
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=3))+
  scale_y_continuous(labels = scales::percent) +
  labs(title = "Gain in Median Household Income in Maryland",
       subtitle = "2010 -> 2020 Census for Largest Cities, Towns",
       caption = "Graphic by Rob Wells, 7-19-2022",
       y="Pct Change 2010 vs 2020",
       x="Place")

ggsave("md_city_summary.png",device = "png",width=9,height=6, dpi=800)


```

```{r}
#Chart of cities, shortened

md_city_summary %>% 
  top_n(25, Pct_Income_Chg) %>% 
ggplot(aes(x = reorder(place, -Pct_Income_Chg), y = Pct_Income_Chg,
             fill = Pct_Income_Chg)) +
  geom_col(position = "dodge") + 
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=10))+
  scale_y_continuous(labels = scales::percent) +
  labs(title = "Gain in Median Household Income in Maryland",
       subtitle = "2010 -> 2020 Census for Largest Cities, Towns",
       caption = "Graphic by Rob Wells, 7-19-2022",
       y="Pct Change 2010 vs 2020",
       x="Place")

ggsave("top_md_city_summary.png",device = "png",width=9,height=6, dpi=800)


```

# Per Capita Income

```{r}
#2020 Per Capita By Census Tract ACS
#2016-2020
#B19001 COUNTS THE NUMBER OF HOUSEHOLDS
#B19301_001 is the per capita income "Per capita income in the past 12 months (in 2020 inflation-adjusted dollars"
#Documentation: https://censusreporter.org/tables/B19301/
percap_income2020 <- get_acs(geography = "tract", 
              variables = c(number_households = "B19001_001", percap_income = "B19301_001"), 
               state = "MD", 
               year = 2020) %>% 
  mutate(year=("2020"))

 
percap_income2020

```

```{r}
#2016 & 2010 Per Capita Income By Census Tract ACS

percap_income2016 <- get_acs(geography = "tract", 
              variables = c(number_households = "B19001_001", percap_income = "B19301_001"), 
               state = "MD", 
               year = 2016) %>% 
  mutate(year=("2016"))
 
#2010 Per Capita Income By Census Tract 2010
percap_income2010 <- get_acs(geography = "tract", 
              variables = c(number_households = "B19001_001", percap_income = "B19301_001"), 
               state = "MD", 
               year = 2010) %>% 
  mutate(year=("2010"))
 
```

Create Baltimore city-county, city files

```{r}
#Bind together 2010, 2016, 2020 files

percap_md_all <- rbind(percap_income2010, percap_income2016, percap_income2020)

percap_md_all <- separate(data = percap_md_all, col = NAME, into = c("Census_Tract", "County", "State"), sep = ",", extra = "merge", fill = "right")

#write.csv(md_income_all, "md_income_all.csv")

#Subset Baltimore city-county, city files
balt_income_all <- filter(percap_md_all, grepl ("Baltimore", County))
#write.csv(balt_income_all, "balt_income_all.csv")

#Baltimore city median income, 2010, 2016, 2020

baltcity_percap_income <- filter(balt_income_all, grepl ("Baltimore city", County)) %>% 
  filter(variable=="percap_income")

```

```{r}
#reshape baltcity_income table

baltcity_percap_income <- baltcity_percap_income %>% 
  select(-moe) %>% 
  pivot_wider(names_from = "year", values_from = "estimate")

baltcity_percap_income <- janitor::clean_names(baltcity_percap_income)

baltcity_percap_income <- baltcity_percap_income %>% 
  mutate(diff_2020_2010 = (x2020-x2010)) %>% 
  mutate(diff_2020_2016 = (x2020-x2016))

#write.csv(baltcity_percap_income, "baltcity_percap_income.csv")
# write_rds(baltcity_income, "baltcity_income.rds")
```

# Map Median Income by Census Tract

```{r}
#subset the geometry
md_income2020_geo <- get_acs(geography = "tract", 
              variables = c(number_households = "B19001_001", percap_income = "B19301_001"), 
               state = "MD", 
               year = 2020, geometry = TRUE) %>% 
  mutate(year=("2020")) %>% 
  select(GEOID, NAME)

#join geocoordinates with baltcity
baltcity_percap_income <- md_income2020_geo  %>% 
 right_join(baltcity_percap_income, by=c("GEOID"="geoid")) %>% 
  distinct() %>%
  clean_names()

#join Community Statistical Area names
#associates neighborhood names to Census Tracts using Community Statistical Areas, 2010 https://bniajfi.org/mapping-resources/

#Baltimore has 56 neighborhoods as measured by Community Statistical Areas
csa <- read_csv("balt_census_crosswalks_2020.csv") %>%
  rename(
    geoid = GEOID_Tract_2020
  ) %>%
  clean_names()

csa$geoid <- as.character(csa$geoid)

#Rename Columns

baltcity_percap_income <- baltcity_percap_income %>% 
  right_join(csa, by=c("geoid")) %>% 
  distinct() 

#write_rds(baltcity_income, "baltcity_income.rds")
write.csv(baltcity_percap_income, "baltcity_percap_income.csv")
#Census Tracts 1801, 1802 have no data for 2020, but have data for 2010, 2016

```


```{r}
#Map by Median Income Difference
baltcity_percap_income <- baltcity_percap_income %>% 
  sf::st_transform('+proj=longlat +datum=WGS84')

pal <- colorNumeric(
  palette = "inferno",
  domain = baltcity_percap_income$Diff_2020_2010
)

#https://leaflet-extras.github.io/leaflet-providers/preview/
percapta_Map <- leaflet() %>%
  addProviderTiles(providers$Esri.WorldStreetMap) %>%
  addPolygons(data = baltcity_percap_income,
              color = ~pal(diff_2020_2010),
              weight = 2.5,
              smoothFactor = 0.2,
              fillOpacity = 0.5,
              label = paste("Change is:",(scales::dollar(baltcity_percap_income$diff_2020_2010)), "for",baltcity_percap_income$community_statistical_area_2020)) %>% 
  addLegend(
    position = "bottomright",
    pal = pal,
    values = baltcity_percap_income$diff_2020_2010,
    title = "Per Capita Income Change<br>Per Census Tract <br> 2010 to 2020"
  )

library(htmlwidgets)
saveWidget(percapta_Map, "percapta_Map.html")
percapta_Map
```

## Aggregate Income Analysis + Map -- Shreya 
```{r}
acs_2020_vars <- load_variables(year = 2020,
                      dataset = "acs5")

## pulling aggregate income for MD in 2020 and 2010
aggregate_income_2020 <- get_acs(
  geography = "tract", 
  state = "MD",
  variables = c(aggregate_income = "B19313_001"),
  year = 2020,
  geometry = TRUE) %>% 
  mutate(year=("2020")) %>%
  clean_names() %>%
  separate(name, into=c("tract","name","state"), sep=",") %>%
  mutate(
    state = str_trim(state,side="both"),
    name = str_trim(name,side="both")
      ) 

aggregate_income_2010 <- get_acs(
  geography = "tract", 
  state = "MD",
  variables = c(aggregate_income = "B19313_001"),
  year = 2010,
  geometry = TRUE) %>% 
  mutate(year=("2010")) %>%
  clean_names() %>%
  separate(name, into=c("tract","name","state"), sep=",") %>%
  mutate(
    state = str_trim(state,side="both"),
    name = str_trim(name,side="both")
      ) 

bmore_ag_income_2020 <- aggregate_income_2020 %>%
  filter(name == "Baltimore city") %>%
  rename(
    ag_income_2020 = estimate
  ) %>%
  as.data.frame() 

bmore_ag_income_2010 <- aggregate_income_2010 %>%
  filter(name == "Baltimore city") %>%
  rename(
    ag_income_2010 = estimate
  ) %>%
  as.data.frame()

### join together so 2010 and 2020 estimates are in the same df
bmore_ag_differences <- bmore_ag_income_2020 %>%
  left_join(bmore_ag_income_2010, by=c("geoid")) %>%
  dplyr::select(geoid, tract.x, state.x, ag_income_2020, geometry.x, ag_income_2010) %>%
  rename(
    tract = tract.x,
    state = state.x,
    geometry = geometry.x 
  ) %>%
  mutate(
    diff_ag_income = (ag_income_2020 - ag_income_2010)
  )

### incorporating community statistical areas into data 
#Baltimore has 56 neighborhoods as measured by Community Statistical Areas
csa <- rio::import("https://raw.githubusercontent.com/profrobwells/Baltimore/main/CTA_CSA_2010.csv") %>%
  rename(
    geoid = GEOID10
  ) %>%
  clean_names()

csa$geoid <- as.character(csa$geoid)

## wgs projection
wgs <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"

## rename columns
bmore_ag_differences_join <- bmore_ag_differences %>% 
  right_join(csa, by=c("geoid")) %>% 
  distinct() %>% 
  rename(neighborhood = csa2010,
  census_tract = name10) 

## making spatial object for map 
spatial_bmore_ag_differences <- bmore_ag_differences_join %>%
  st_as_sf(crs = wgs)

## ag_pal 

ag_pal <- colorNumeric(
      palette = "inferno",
      domain = spatial_bmore_ag_differences$diff_ag_income
    )

## leaflet map here
ag_map <- leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(data = spatial_bmore_ag_differences,
              color = ~ag_pal(diff_ag_income),
              weight = 2.5,
              smoothFactor = 0.2,
              fillOpacity = 0.5,
              label = paste("Change is:",(scales::dollar(spatial_bmore_ag_differences$diff_ag_income)), "for",spatial_bmore_ag_differences$neighborhood)) %>% 
  addLegend(
    position = "bottomright",
    pal = ag_pal,
    values = spatial_bmore_ag_differences$diff_ag_income,
    title = "Aggregate Income Change<br>Per Census Tract <br> 2010 to 2020"
  )

ag_map

##saving widget!
saveWidget(ag_map, "aggregate_income_map.html")

```

```{r}


### reading in redlining map shapefiles
redlining_maps <- st_read("Tracts_2020_HOLC/Tracts_2020_HOLC.shp") 

balt_redlining <- redlining_maps %>%
  clean_names() %>%
  filter(max_city == "Baltimore") %>%
  st_transform(crs = wgs)
d_regions <- balt_redlining %>%
  filter(first_holc == "D")
## pulling race data from ACS
race_2020 <- get_acs(
  geography = "tract", 
  state = "MD",
  variables = 
    c(total_population = "B03002_001",
      white_pop = "B03002_003",
      black_pop = "B03002_004",
      hisp_lat_pop = "B03002_012",
      asian_pop = "B03002_006"),
  year = 2020,
  geometry = TRUE,
  output = "wide"
  ) %>% 
  mutate(year=("2020")) %>%
  clean_names() %>%
  separate(name, into=c("tract","name","state"), sep=",") %>%
  mutate(
      state = str_trim(state,side="both"),
      name = str_trim(name,side="both")
  ) %>%
  filter(name == "Baltimore city")
balt_race_percentages <- race_2020 %>%
  mutate(
    percent_white = round((white_pop_e/total_population_e) * 100, 2),
    percent_black = round((black_pop_e/total_population_e) * 100, 2),
    percent_hisp_lat = round((hisp_lat_pop_e/total_population_e) * 100, 2),
    percent_asian = round((asian_pop_e/total_population_e) * 100, 2) 
    ) %>%
  select(geoid, tract, name, state, percent_white, percent_black, percent_hisp_lat, percent_asian, total_population_e) %>%
  rename(total_population = total_population_e)

## incorporating CSAs
### incorporating community statistical areas into data 
#Baltimore has 56 neighborhoods as measured by Community Statistical Areas
csa <- read_csv("balt_census_crosswalks_2020.csv") %>%
  rename(
    geoid = GEOID_Tract_2020
  ) %>%
  clean_names()

csa$geoid <- as.character(csa$geoid)

## joining race percentages to CSAs
balt_race_percentages_join <- balt_race_percentages %>% 
  right_join(csa, by=c("geoid")) %>% 
  distinct() %>% 
  rename(neighborhood = community_statistical_area_2020,
  census_tract = tract_2020) 

#palettes 
rlining_pal <- colorQuantile(
      palette = "YlGnBu",
      domain = baltcity_percap_income$diff_2020_2010,
      10,
      reverse = TRUE
    )

black_pal <- colorBin(
      palette = "YlGnBu",
      domain = balt_race_percentages_join$percent_black
    )

white_pal <- colorBin(
      palette = "YlGnBu",
      domain = balt_race_percentages_join$percent_white,
      5
    )

  
## overlaying redlining shapefiles on top of leafMap (median household income)
rlining_and_demographics <- leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(group = "Per Capita Income",
              data = baltcity_percap_income,
              color = ~rlining_pal(diff_2020_2010),
              weight = 2.5,
              smoothFactor = 0.2,
              fillOpacity = 0.7,
              label = paste("Change is:",(scales::dollar(baltcity_percap_income$diff_2020_2010)), "for",balt_race_percentages_join$neighborhood)) %>% 
  addPolygons(group = "Black Population",
              data = balt_race_percentages_join,
              color = ~black_pal(percent_black),
              weight = 2.5,
              smoothFactor = 0.2,
              fillOpacity = 0.7,
              label = paste("Percent Black:",(balt_race_percentages_join$percent_black), "for",balt_race_percentages_join$neighborhood, "|", "Percap $ Change is:",(scales::dollar(baltcity_percap_income$diff_2020_2010)), "for",balt_race_percentages_join$neighborhood)) %>%
  addPolygons(group = "White Population",
              data = balt_race_percentages_join,
              color = ~white_pal(percent_white),
              weight = 2.5,
              smoothFactor = 0.2,
              fillOpacity = 0.7,
              label = paste("Percent White:",(balt_race_percentages_join$percent_white), "for",balt_race_percentages_join$neighborhood, "|", "Percap $ Change is:",(scales::dollar(baltcity_percap_income$diff_2020_2010)), "for",balt_race_percentages_join$neighborhood)) %>%
  ### needs to be polylines because otherwise hover gets messed up
  addPolylines(
    group = "Redlining Zones",
    data = d_regions,
    color = "Red",
    weight = 5,
    smoothFactor = 1
  ) %>%
  addLegend(
    group = "White Population",
    position = "bottomright",
    pal = white_pal,
    values = balt_race_percentages_join$percent_white,
    title = "Percentage White in 2020"
  ) %>% 
  addLegend(
    group = "Per Capita Income",
    position = "bottomright",
    pal = rlining_pal,
    values = baltcity_percap_income$diff_2020_2010,
    title = "Per Capita Income Change<br>Per Census Tract <br> 2010 to 2020"
  ) %>% 
  addLegend(
    group = "Black Population",
    position = "bottomright",
    pal = black_pal,
    values = balt_race_percentages_join$percent_black,
    title = "Percentage Black in 2020"
  ) %>%
  ### controls layers for toggle
  addLayersControl(
    baseGroups = c("Per Capita Income", "Black Population", "White Population"),
    position = "topleft", 
    options = layersControlOptions(collapsed = FALSE)
  ) %>%
  ### extra Javascript so that redlining layers stay as a top layer
   onRender("
    function(el, x) {
      this.on('baselayerchange', function(e) {
        e.layer.bringToBack();
      })
    }
  ")
 
rlining_and_demographics 
saveWidget(rlining_and_demographics , "rlining_and_demographics.html")


```


Writing out data
```{r}

##write out these dataframes to shiny_app data folder in rds format (easier to read by shiny)

#race df
write_rds(balt_race_percentages_join, "shiny_app/data/balt_race_percentages_join.rds")

#income df
write_rds(baltcity_percap_income, "shiny_app/data/baltcity_percap_income.rds" )

#redliningdf
write_rds(d_regions, "shiny_app/data/d_regions.rds")

```


## Commentary on Per Capita Income Map 

I cranked out a new version of that income map that is based on per-capita income instead of median household income. 

So this new map basically measures individual average income in a census tract. 
The first version measured the median household income, so most everyone under one roof.

I feel this addresses Sandy’s “WTF?” question about the boom of wealth in her neighborhood and a lot of other weirdness that didn’t make sense to me either. There is still some statistical mumbo-jumbo here that I will try to work through but this seems to tell a much more accurate story in my view.
https://profrobwells.github.io/Baltimore/percapta_Map.html

But look at the boom in South Baltimore! Locust Point! YOWZA.  

And for reference, the first map of median household income.
Median Income Map
https://profrobwells.github.io/Baltimore/leafMap.html

# Notes on Income Inequality

Shreya - I am starting to look at the differences between the Median Household Income, Per Capita Income and Aggregate Income. I am thinking the Aggregate Income might be the best measure of wealth in a neighborhood, so go ahead and pull the data for Table B19313 and map that.

And then I'd like for you to explore tables that measure income inequality by quintile. 
B19082 	Shares of Aggregate Household Income by Quintile
B19083 	Gini Index of Income Inequality

I havent looked at this and don't know it it would be something to map or not.

All of these notes start at Line 426 in Balt_Income_Map_7_2022.rmd
Thanks, Rob

# Notes in income inequality
From:  https://censusreporter.org/tables/B19301/
https://censusreporter.org/topics/income/


**Aggregate income**
The various aggregate income tables provide the total amount of income, as well as broken down by income type, for the summary geography.
**Table B19313** aggregates all income in the geography, which will produce a number somewhat higher than B19025 because it includes people who live in "group quarters."

**Table B19301, "Per Capita income"**, is simply the value for B19313 "Aggregate Income" divided by the total population estimate for the summary geography. This statistic is more or less the 'average' income. Note the potential for misunderstanding: A) the aggregate income is divided among all people, not only those who actually had income, and B) as with any average, outliers (very big earners) can have a disproportionate effect on resulting figure.


There are also some tables which are particularly applicable to understanding income inequality, including one, **B19083 which provides the Gini index** for a place as its only column. 

Income is reported in a number of ways: 
as a median value, 
or as a series of medians for groups within a total population; 
as a number of people or households earning in a certain bracket; 
as well as a few other structures.

**Income distribution and Inequality**

A few tables in the American Community Survey can be used to understand how income is distributed in given geographies. Two of these tables divide the population of an area into five "quintiles," each with approximately the same number of households in it. For households in those quintiles, you can find the highest income for each quintile, the mean (average) income for each quintile, and the share (percentage) of total income taken in by each quintile.

There is also a table reporting the Gini index for each geography, which summarizes the income distribution in that place. The Gini index is a number between 0 and 1, where lower numbers reflect more equality, and higher numbers indicate greater inequality. You can learn more about the Gini index on this page from the Census Bureau
Code 	Title
B19080 	Household Income Quintile Upper Limits
B19081 	Mean Household Income of Quintiles
B19082 	Shares of Aggregate Household Income by Quintile
B19083 	Gini Index of Income Inequality

# --------------------------------------
# Maryland Data Import:  Smith School 
# --------------------------------------

```{r}
md <- rio::import("../data/maryland_tracts.xls") %>% 
  as.data.frame()

md <- md %>% 
  clean_names() %>% 
  mutate(census = as.character(tract)) %>% 
  mutate(county = as.numeric(strtrim(tract, 5)))

#MD counties
md_counties <- rio::import("/Users/robwells/Downloads/md_counties_geoids.txt")

md_named <- md %>% 
  inner_join(md_counties, by=c("county"="GEOID"))

write.csv(md_named, "../output/md_smith_data_12.16.csv")


```

# --------------------------------------
# Work in Progress Below
# --------------------------------------
#SBA data
Explanation from IRE webpage:
https://www.ire.org/product/sba-7a-business-loans/
Description

The SBA 7a business loans database contains information about loans guaranteed by the U.S. Small Business Administration under its main lending program, known as 7a. The data include loans approved by the SBA since 1990, when Congress created the agency to help entrepreneurs form or expand small enterprises. The SBA's 7a program provides loans to small business owners who can't obtain financing through traditional channels. The program operates through private-sector lenders who provide loans that are, in turn, guaranteed by the SBA. The SBA7a program itself has no funds for direct lending or grants. The data contain information on the business getting the loan including address and industry code, the bank lending the money, the amount loaned, and (where applicable) whether the loan was paid in full or charged off.

Explanation of 504 loan program


What is the 504 loan program?
https://www.sba.gov/funding-programs/loans/504-loans
The 504 Loan Program provides long-term, fixed rate financing for major fixed assets that promote business growth and job creation.

504 loans are available through Certified Development Companies (CDCs), SBA's community-based partners who regulate nonprofits and promote economic development within their communities. CDCs are certified and regulated by SBA.

The maximum loan amount for a 504 loan is $5.5 million. For certain energy projects, the borrower can receive a 504 loan for up to $5.5 million per project, for up to three projects not to exceed $16.5 million total.



To be eligible for a 504 loan, your business must: 

    Operate as a for-profit company in the United States or its possessions
    Have a tangible net worth of less than $15 million
    Have an average net income of less than $5 million after federal income taxes for the two years preceding your application

Other general eligibility standards include  falling within SBA size guidelines, having qualified management expertise, a feasible business plan, good character and the ability to repay the loan.

Loans cannot be made to businesses engaged in nonprofit, passive, or speculative activities. For additional information on eligibility criteria and loan application requirements, small businesses and lenders are encouraged to contact a Certified Development Company in their area.


```{r}
sba <- rio::import("/Users/robwells/Library/CloudStorage/GoogleDrive-robwells@umd.edu/My Drive/Baltimore Jour 327 Spring 2024/sba7a_sample-1.csv")


#https://data.sba.gov/en/dataset/7-a-504-foia/resource/e8023bd1-7d8e-4bd2-8346-47cb6b367beb
#FOIA - 504 (FY2010-Present) as of 230930.csv
#These are the 504 loans
sba2 <- rio::import("/Users/robwells/Library/CloudStorage/GoogleDrive-robwells@umd.edu/My Drive/Baltimore Jour 327 Spring 2024/foia-504-fy2010-present-asof-230930.csv")

#Only 46 records
sba_baltimore_504 <- sba2 %>% 
  filter(BorrCity=="Baltimore") %>% 
   filter(BorrState=="MD")


summary(sba_baltimore_504$GrossApproval)
 #  Min.    1st Qu.  Median    Mean     3rd Qu.      Max. 
 # 178,000  403,250  715,000 1,044,696 1,460,000 4,415,000 

#FOIA - 7(a)(FY2020-Present) as of 230930.csv
#https://data.sba.gov/en/dataset/7-a-504-foia/resource/c71ba6cf-b4e0-4e60-98f0-48aeaf4c6460

#these are the 7a Loans
sba3 <- rio::import("/Users/robwells/Library/CloudStorage/GoogleDrive-robwells@umd.edu/My Drive/Baltimore Jour 327 Spring 2024/foia-7afy2020-present-asof-230930.csv")

#Only 126 records, 2000-2023
sba_baltimore_7a <- sba3 %>% 
  filter(BorrCity=="Baltimore") %>% 
  filter(BorrState=="MD")

summary(sba_baltimore2$GrossApproval)
   # Min. 1st Qu.     Median     Mean   3rd Qu.    Max. 
   # 7,500   35,000  100,000  434,700  423,750 4,449,000 

```

## Geocode 7a loans

```{r}
library(tidyr)
#install.packages("ggmap")
library(ggmap)
register_google(key = " ")

sba_baltimore_7a <- sba_baltimore_7a %>% 
  mutate(fulladdress = paste(BorrStreet, BorrCity, BorrState, BorrZip, sep = ", "))

sba_baltimore_7a <- sba_baltimore_7a %>% 
  mutate(geo = geocode(fulladdress)) 

sba_baltimore_7a <- sba_baltimore_7a %>% 
  unnest(geo)

sba_baltimore_7a <- sba_baltimore_7a %>% 
  as.data.frame()

write_csv(sba_baltimore_7a, "../data/sba_baltimore_7a.csv")

```


## Convert lat-long to census blocks
https://www.fcc.gov/general/census-block-conversions-api-v100
```{r}



# Load the necessary library
library(httr)

# Define a function to get the census block for a given lat and long
get_census_block <- function(lat, long) {
  # Define the base URL for the API
  base_url <- "https://geo.fcc.gov/api/census/block/find"
  
  # Make the GET request
  response <- GET(url = base_url, query = list(latitude = lat, longitude = long, format = "json"))
  
  # Parse the response content to JSON
  content <- content(response, "parsed")
  
  # Return the FIPS code for the census block
  return(content$Block$FIPS)
}

# Apply the function to each row in df1
# df1$census_block <- mapply(get_census_block, df1$lat, df1$long)
sba_baltimore_7a$census_block <- mapply(get_census_block, sba_baltimore_7a$lat, sba_baltimore_7a$lon)
# 
# # Use the function to get the census block for a given lat and long
# census_block <- get_census_block(lat = 39.34476, long = -76.51560)
# 
# # Print the census block
# print(census_block)

```


lynch_geocoded_10.8 <- lynch_geocoded_10.8  %>%
  unnest(lynching)

lynch_geocoded_10.8 <- lynch_geocoded_10.8  %>%
    rename(lynching.lon = lon, lynching.lat = lat) 


```




#find top zip code neighborhoods by sba loan
```{r}
#zip to neighborhood file
zip <- rio::import("../data/Zip-to-CSA-2010.xls")

zip %>% 
  count(Zip2010) %>% 
  arrange(desc(n))

sba_baltimore3 <- sba_baltimore2 %>% 
  right_join(zip, by=c("BorrZip"="Zip2010"))

```




#race by tract
```{r}

#join with map - white /nonwhite for tooltip
#how white / nonwhite changed during the decade by tract

#2020: B02001_001 Estimate!!Total RACE
race2020 <- get_acs(geography = "tract", 
              variables = c(total = "B02001_001", white = "B02001_002", black = "B02001_003", hispanic = "B03001_003"), 
               state = "MD", 
               year = 2020) %>% 
  mutate(year=("2020"))

race2010 <- get_acs(geography = "tract", 
              variables = c(total = "B02001_001", white = "B02001_002", black = "B02001_003", hispanic = "B03001_003"), 
               state = "MD", 
               year = 2010) %>% 
  mutate(year=("2010"))
```

```{r}
md_race_all <- rbind(race2010, race2020)

md_race_all <- separate(data = md_race_all, col = NAME, into = c("Census_Tract", "County", "State"), sep = ",", extra = "merge", fill = "right")

#write.csv(md_income_all, "md_income_all.csv")

#Subset Baltimore city-county, city files
balt_race <- filter(md_race_all, grepl ("Baltimore", County))
#write.csv(balt_income_all, "balt_income_all.csv")

#Baltimore city median income, 2010, 2016, 2020

baltcity_race <- filter(balt_race, grepl ("Baltimore city", County)) 

```

```{r}
#reshape baltcity_income table

 baltcity_race2 <- baltcity_race %>% 
   dplyr::select(-moe, -State) %>% 
  pivot_wider(names_from = "year", values_from = "estimate")

baltcity_race2 <- janitor::clean_names(baltcity_race2)

 baltcity_race3 <- baltcity_race2 %>% 
  pivot_wider(names_from = "variable", values_from = c(x2010, x2020))

baltcity_race <- baltcity_race3 %>%
   mutate(Pct_White_2020 = (x2020_white/x2020_total)) %>%
   mutate(Pct_White_2010 = (x2010_white/x2010_total)) %>%
   mutate(White_Pct_Diff_2020 = (Pct_White_2020-Pct_White_2010)) %>%
   as.data.frame()

library(formattable)

 baltcity_race$Pct_White_2010 <- formattable::percent(baltcity_race$Pct_White_2010)
 baltcity_race$Pct_White_2020 <- formattable::percent(baltcity_race$Pct_White_2020)
 baltcity_race$White_Pct_Diff_2020 <- formattable::percent(baltcity_race$White_Pct_Diff_2020)

#special output for the class
#write.csv(baltcity_race3, "DataOutput/baltcity_race_7_21.csv")

```


```{r}
#Revising data for the Fall class assignment
baltcity_income_clean <- baltcity_income %>% 
  as.data.frame() %>% 
  select(Neighborhood, x2010, x2016, x2020, Census, GEOID) %>% 
  arrange(Census)
write_csv(baltcity_income_clean, "baltcity_income_clean.csv")
```

# Redlining Maps

```{r}
#Overlay with HOLC redlining maps
#https://s3.amazonaws.com/holc/tiles/MD/Baltimore/1937/holc-scan.jpg
#install.packages("rjson")
library("rjson")
holc <- fromJSON(file="/Volumes/GoogleDrive/My Drive/Baltimore Class/Tracts_2020_HOLC/Tracts_2020_HOLC.geojson")

#install.packages("rgdal")
library(rgdal)
library(raster)
holc1 <- shapefile("/Volumes/GoogleDrive/My Drive/Baltimore Class/Tracts_2020_HOLC/Tracts_2020_HOLC.shp")

holc2 <- holc1@data %>% 
  filter(MAX_city=="Baltimore")

```

```{r}
#Notes on embedding and formatting Leaflet

#https://profrobwells.github.io/Baltimore/leafMap.html


#<iframe seamless src="/static/leaflet/leafmap/index.html" width="100%" height="500"></iframe>
#https://waterdata.usgs.gov/blog/leaflet/
#https://github.com/profrobwells/Test/blob/master/leafMap.html
#https://leaflet-extras.github.io/leaflet-providers/preview/


#notes on old code
#label = ~Diff_2020_2010) %>%
              #label = paste("Change is:  $",baltcity_income$Diff_2020_2010, ",",baltcity_income$census_tract)) %>% 

#next up

#Put population and %white in popup
#Get more details on how to format popups

```


# Population and Income Analysis
```{r}
race_2020 <- get_acs(
  geography = "tract", 
  state = "MD",
  variables = 
    c(x2020_total_population = "B03002_001",
      white_pop = "B03002_003",
      black_pop = "B03002_004",
      hisp_lat_pop = "B03002_012",
      asian_pop = "B03002_006"),
  year = 2020,
  geometry = TRUE,
  output = "wide"
  ) %>% 
  mutate(year=("2020")) %>%
  clean_names() %>%
  separate(name, into=c("tract","name","state"), sep=",") %>%
  mutate(
      state = str_trim(state,side="both"),
      name = str_trim(name,side="both")
  ) %>%
  filter(name == "Baltimore city")

```

2010 population
```{r}
race_2010 <- get_acs(
  geography = "tract", 
  state = "MD",
  variables = 
    c(x2010_total_population = "B03002_001",
      white_pop = "B03002_003",
      black_pop = "B03002_004",
      hisp_lat_pop = "B03002_012",
      asian_pop = "B03002_006"),
  year = 2010,
  geometry = TRUE,
  output = "wide"
  ) %>% 
  mutate(year=("2010")) %>%
  clean_names() %>%
  separate(name, into=c("tract","name","state"), sep=",") %>%
  mutate(
      state = str_trim(state,side="both"),
      name = str_trim(name,side="both")
  ) %>%
  filter(name == "Baltimore city")


```


## Per Capita Income

2020 
```{r}
#2020 Per Capita By Census Tract ACS
#2016-2020
#B19001 COUNTS THE NUMBER OF HOUSEHOLDS
#B19301_001 is the per capita income "Per capita income in the past 12 months (in 2020 inflation-adjusted dollars"
#Documentation: https://censusreporter.org/tables/B19301/
percap_income2020 <- get_acs(geography = "tract", 
              variables = c(number_households = "B19001_001", percap_income = "B19301_001"), 
               state = "MD", 
               year = 2020) %>% 
  mutate(year=("2020"))

 
percap_income2020

```

```{r}
race_2010 <- race_2010 %>% 
  as.data.frame()
race_2020 <- race_2020 %>% 
  as.data.frame()

race_all <- race_2010 %>% 
  inner_join(race_2020, by=c("geoid"))

race_all <- race_all %>% 
  select(geoid, tract.x, name.x, x2010_total_population_e, x2020_total_population_e, geometry.x)

```


```{r}
#2016 & 2010 Per Capita Income By Census Tract ACS

percap_income2016 <- get_acs(geography = "tract", 
              variables = c(number_households = "B19001_001", percap_income = "B19301_001"), 
               state = "MD", 
               year = 2016) %>% 
  mutate(year=("2016"))
 
#2010 Per Capita Income By Census Tract 2010
percap_income2010 <- get_acs(geography = "tract", 
              variables = c(number_households = "B19001_001", percap_income = "B19301_001"), 
               state = "MD", 
               year = 2010) %>% 
  mutate(year=("2010"))
 
```

Create Baltimore city-county, city files

```{r}
#Bind together 2010, 2016, 2020 files

percap_md_all <- rbind(percap_income2010, percap_income2016, percap_income2020)

percap_md_all <- separate(data = percap_md_all, col = NAME, into = c("Census_Tract", "County", "State"), sep = ",", extra = "merge", fill = "right")

#write.csv(md_income_all, "md_income_all.csv")

#Subset Baltimore city-county, city files
balt_income_all <- filter(percap_md_all, grepl ("Baltimore", County))
#write.csv(balt_income_all, "balt_income_all.csv")

#Baltimore city median income, 2010, 2016, 2020

baltcity_percap_income <- filter(balt_income_all, grepl ("Baltimore city", County)) %>% 
  filter(variable=="percap_income")

```

```{r}
#reshape baltcity_income table

baltcity_percap_income <- baltcity_percap_income %>% 
  select(-moe) %>% 
  pivot_wider(names_from = "year", values_from = "estimate")

baltcity_percap_income <- janitor::clean_names(baltcity_percap_income)

baltcity_percap_income <- baltcity_percap_income %>% 
  mutate(Diff_2020_2010 = (x2020-x2010)) %>% 
  mutate(Diff_2020_2016 = (x2020-x2016))

# write.csv(baltcity_percap_income, "baltcity_percap_income.csv")
# write_rds(baltcity_income, "baltcity_income.rds")
```

## Join per capita and percap income

```{r}
joined <- baltcity_percap_income %>% 
  inner_join(race_all, by=c("geoid"))

joined <- joined %>% 
  select(geoid, census_tract, x2010, x2016, x2020, Diff_2020_2010, x2010_total_population_e, x2020_total_population_e, geometry.x)

joined <- joined %>% 
  mutate(pop_diff_2020 = (x2020_total_population_e - x2010_total_population_e)) %>% 
  mutate(pct_chg_pop_2020 = (x2020_total_population_e - x2010_total_population_e)/x2010_total_population_e)
  
joined$pct_chg_pop_2020 <- formattable::percent(joined$pct_chg_pop_2020)


joined <- joined %>% 
  mutate(pct_chg_income_2020 = (x2020-x2010)/x2010)

joined$pct_chg_income_2020  <- formattable::percent(joined$pct_chg_income_2020)

#write.csv(joined, "balt_income_pop.csv")
```

On average, a Baltimore census tract lost 92 residents from 2010 to 2020. The biggest loss was 1838 residents.


```{r}
summary(joined$pop_diff_2020)
sum(joined$pop_diff_2020)
```

```{r}

csa <- read_csv("balt_census_crosswalks_2020.csv") %>%
  rename(
    geoid = GEOID_Tract_2020
  ) %>%
  clean_names()

csa$geoid <- as.character(csa$geoid)

joined <- joined  %>% 
  clean_names() %>%
  right_join(csa, by=c("geoid")) %>% 
  distinct() 

joined <- joined %>% 
  select(community_statistical_area_2020, x2010, x2016, x2020, diff_2020_2010, pct_chg_income_2020, x2010_total_population_e, x2020_total_population_e, pop_diff_2020, pct_chg_pop_2020, census_tract, geometry_x)
```

The typical Baltimore Census tract saw a 35% increase in per capita income from 2010 to 2020. 
The top quarter neighborhoods saw a 58% or better increase
The top 10% neighborhoods saw a 85% or better increase
```{r}
summary(joined$pct_chg_income_2020)
quantile(joined$pct_chg_income_2020, c(0.25, 0.50, 0.75, 0.9, 0.99), na.rm=TRUE)

```

The 49 neighborhoods that saw incomes rise 58% or more
```{r}
joined %>% 
  select(community_statistical_area_2020, pct_chg_income_2020, pct_chg_pop_2020) %>% 
  filter(pct_chg_income_2020 > 0.5836) %>% 
  arrange(desc(pct_chg_income_2020))

```

The 49 neighborhoods that saw incomes rise 58% or more had a population loss that averaged 4%.
```{r}
joined %>% 
  select(community_statistical_area_2020, pct_chg_income_2020, pct_chg_pop_2020) %>% 
  filter(pct_chg_income_2020 > 0.5836) %>% 
  summarize(mean(pct_chg_pop_2020))
```

The 151 neighborhoods that saw incomes rise less than 58% or more had a population gain of a little less than 1%
```{r}
joined %>% 
  select(community_statistical_area_2020, pct_chg_income_2020, pct_chg_pop_2020) %>% 
  filter(pct_chg_income_2020 < 0.5836) %>% 
  summarize(mean(pct_chg_pop_2020))
```

The 50 neighborhoods that saw incomes rise less than 15% or more had a population gained 3%
```{r}
joined %>% 
  select(community_statistical_area_2020, pct_chg_income_2020, pct_chg_pop_2020) %>% 
  filter(pct_chg_income_2020 < 0.1490 ) %>% 
  summarize(mean(pct_chg_pop_2020))
```

The 50 neighborhoods that saw incomes rise less than 15% 
```{r}
joined %>% 
  select(community_statistical_area_2020, pct_chg_income_2020, pct_chg_pop_2020) %>% 
  filter(pct_chg_income_2020 < 0.1490) %>% 
  arrange(desc(pct_chg_income_2020))
```

# Md Cities Per Cap
```{r}
percap2_income2020 <- get_acs(geography = "place", 
              variables = c(number_households = "B19001_001", percap_income = "B19301_001"), 
               state = "MD", 
               year = 2020) %>% 
  mutate(year=("2020"))

 percap2_income2010 <- get_acs(geography = "place", 
              variables = c(number_households = "B19001_001", percap_income = "B19301_001"), 
               state = "MD", 
               year = 2010) %>% 
  mutate(year=("2010"))

 percap2_income <- rbind(percap2_income2020, percap2_income2010)


```

```{r}
#reshape percap_md_all table

 percap2_income <-  percap2_income %>% 
  select(-moe) %>% 
  pivot_wider(names_from = "year", values_from = "estimate")

 percap2_income <- janitor::clean_names( percap2_income)

 percap2_income <-  percap2_income %>% 
  mutate(diff_2020_2010 = (x2020-x2010)) 

#write.csv(baltcity_percap_income, "baltcity_percap_income.csv")
# write_rds(baltcity_income, "baltcity_income.rds")
```


```{r}
percap2_income %>% 
  filter(variable=="percap_income") %>% 
  summarize(mean(x2020, na.rm=TRUE))


```

# --------------------------------------
# Notes on zip codes, census tracts
# --------------------------------------

```{r}
#library(tidycensus)
md_tract <- get_acs(
  geography = "tract",
  state = "Maryland",
  variables = c(medinc = "B19013_001"),
  year = 2022,
  output = "wide"
)

#library(tidycensus)
md_tract2 <- get_decennial(
  geography = "tract",
  state = "Maryland",
 variables = "P005003",
  year = 2010,
  output = "wide"
)
#https://www.rdocumentation.org/packages/tidycensus/versions/1.5/topics/get_decennial
md_tract %>% 
  count(GEOID) %>% 
  arrange(desc(n))

cross <- rio::import("../output/md_internet_tracts_2020.csv") %>% 
    mutate(census = as.character(GEOID))

mdplace <- rio::import("/Users/robwells/Downloads/OID_PLACE_20.txt") %>% 
  as.data.frame()


# cross <- rio::import("../data/census_md_place_crosswalk.txt") %>% 
#   select(NAMELSAD_PLACE_20, GEOID_PLACE_20, OID_PLACE_10) %>% 
#   mutate(census = as.character(OID_PLACE_10)) 


md_named <- md %>% 
  inner_join(cross, by=c("census"))
#not a great join - md had 1388 records, md_named 1268 so lost 120 records
md_named2 <- md %>% 
  inner_join(md_tract, by=c("census"="GEOID"))


md_named1 <- md %>% 
  left_join(cross, by=c("census"))

anti_md_named <- md %>% 
  anti_join(cross, by=c("census"))

write.csv(md_named, "../output/md_smith_data_11.14.csv")

#https://www.nhgis.org/geographic-crosswalks



#MD Zip Codes
#https://geodata.md.gov/imap/rest/services/Boundaries/MD_PoliticalBoundaries/FeatureServer/3
# In This Form:
# Where 0=0
# Out Fields= *
# Return Geometery - Yes
# False for everything else
# Format: Html or JSON
library(jsonlite)
qq <- fromJSON('https://geodata.md.gov/imap/rest/services/Boundaries/MD_PoliticalBoundaries/FeatureServer/3/query?where=0%3D0&objectIds=&time=&geometry=&geometryType=esriGeometryEnvelope&inSR=&spatialRel=esriSpatialRelIntersects&distance=&units=esriSRUnit_Foot&relationParam=&outFields=*&returnGeometry=true&maxAllowableOffset=&geometryPrecision=&outSR=&having=&gdbVersion=&historicMoment=&returnDistinctValues=false&returnIdsOnly=false&returnCountOnly=false&returnExtentOnly=false&orderByFields=&groupByFieldsForStatistics=&outStatistics=&returnZ=false&returnM=false&multipatchOption=xyFootprint&resultOffset=&resultRecordCount=&returnTrueCurves=false&returnExceededLimitFeatures=false&quantizationParameters=&returnCentroid=false&sqlFormat=none&resultType=&featureEncoding=esriDefault&f=pjson')

md_zip <- qq[["features"]][["attributes"]]

md_zip <- md_zip %>% 
  mutate(zip = as.numeric(ZIPCODE1))

anti_md_zips <- anti_md_named %>% 
  inner_join(md_zip, by=c("zip"))
```