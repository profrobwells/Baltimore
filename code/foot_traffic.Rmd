---
title: "Baltimore Foot Traffic"
author: "Rob Wells"
date: "2025-01-22"
output: html_document
---
```{r}
library(tidyverse)
```

It contains monthly foot traffic information for 20,000 stores in Baltimore City, Baltimore County, and Anne Arundel County from Jan to July 2024 (NAICS=44,45,71,72, 81). 
For each store, we have the aggregate foot traffic for the month, the same-month foot traffic last year, and the rate of change. You can also find information about the number of unique visitors and their proximityâ€”whether they are from nearby or outside the county.

```{r}
foot <- rio::import("../data/baltimore_foot_traffic.dta")

#write.csv(foot, "baltimore_foot_traffic.csv")
```

```{r}
glimpse(foot)
```

Dundalk zip code 21222
Edgemere 21219, 21052
Brandon Shores 21226

```{r}
#1022 results
focus <- foot |> 
  filter(postal_code == c("21222", "21219","21052", "21226"))

focus |> 
  count(city) |> 
  arrange(desc(n))
```

#Biggest losers

```{r}
loser <- focus |> 
  select(location_name, street_address, dln_visits_yoy, start) |> 
  filter(start > "2024-03-02") |> 
  slice_min(dln_visits_yoy, n = 20)

```

# Table
```{r}
library(kableExtra)
table_output <- loser %>%
  kbl(caption = "Baltimore Businesses Losing Customers") %>%
  kable_classic(full_width = F, html_font = "Cambria") %>%
  column_spec(1, bold = T, border_right = T) %>%
  column_spec(2, bold = F, border_right = T) |> 
  column_spec(3, width = "5em", background = "yellow") |> 
column_spec(4, bold = F, border_right = T) 

cat("<style>
    .caption {
      font-size: 30px !important;
    }
    </style>")
table_output


```
#Geocode Foot Traffic

Build lookup table: 16,475 entries
Foot has multiple entries for the same address
A lookup table will link back to the main database while saving the expense of geocoding 143,000 entries
```{r}
foot_sum <- foot |> 
  mutate(fulladdress = paste(street_address, city, region, postal_code, sep = ", ")) |> 
  distinct(fulladdress, .keep_all = TRUE)


```

### Geocode lookup table
```{r}
library(tidyr)
library(ggmap)
register_google(key = "")


foot_sum <- foot_sum %>% 
  mutate(geo = geocode(fulladdress)) 
write.csv(foot_sum, "foot_traffic_geocode_lookup.csv")

foot_sum <- foot_sum %>% 
  unnest(geo)

#Join with main data

foot_sum_short <- foot_sum |> 
  select(fulladdress, lon, lat)

foot1 <- foot |> 
  mutate(fulladdress = paste(street_address, city, region, postal_code, sep = ", ")) |>
  left_join(foot_sum_short, by=c("fulladdress"))

```

fact check
```{r}
sum(is.na(foot1$lat))

### total the places without lat lon
x <- foot1 |> 
  group_by(city) |> 
  count(is.na(lat)) |> 
  arrange(desc(n)) |> 
  rename(valid = 'is.na(lat)')

foot1 |> 
  group_by(city) |> 
  count() |> 
  arrange(desc(n))

```
#failed spatial join with business data
```{r}
bol <- read.csv("../data/baltimore_bol.csv") |> 
  janitor::clean_names() |> 
  select(company_name,       address_1,          address_2,         
city,               state,              zip,                zip4,              
latitude,           longitude,          phone,              fax,               
website,            email,              employees,          revenue,           
contact_formal_name,first_name,        
middle,             last_name,          suffix,             title,             
     last_published_date, classification, ranking_criteria, list_title, company_id, business_info) 

```

# spatial join
```{r}
foot_traffic_biz <- foot1 |>
  inner_join(bol, by = c("lat" = "latitude", "lon" = "longitude"))

```

# Unemployment Data

```{r}
unem_feb <- rio::import("/Users/robwells/Downloads/Unemployment_Feb2024_March2024.xlsx", sheet="Feb2024" ) |> 
  janitor::clean_names() |> 
  rename(feb_count = count) |> 
   filter(state_code_value=="MD")

unem_march <- rio::import("/Users/robwells/Downloads/Unemployment_Feb2024_March2024.xlsx", sheet="March 2024") |> 
  janitor::clean_names() |> 
  rename(march_count = count) |> 
   filter(state_code_value=="MD")

combined_unem <- unem_feb |> 
  inner_join(unem_march, by=c("zip", "year", "state_code_value")) |> 
  mutate(diff_march_feb = (march_count-feb_count))

write.csv(combined_unem, "combined_unem_feb_march_2024.csv")

```

```{r}

unem_feb |> 
  count(state_code_value) |> 
  arrange(desc(n)) |> 
  filter(state_code_value=="MD")


```

```{r}
unem_march |> 
  count(state_code_value) |> 
  arrange(desc(n))
```

```{r}

combined_unem |> 
  count(state_code_value) |> 
  arrange(desc(n))
```

